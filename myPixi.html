<!DOCTYPE html>
<!-- pixi js 初次嘗試 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixi Demo</title>
  <script src="https://pixijs.download/release/pixi.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
</head>
<body>
  <h2 class="text-center">pixi js 初次嘗試</h2>
  <script>
    // 螢幕寬度
    let containerWidth = 640;
    let containerHeight = 360;
    if(window.innerWidth < containerWidth){
      containerWidth = window.innerWidth;
      containerHeight = 600;
    }
    
    // 容器設定
    let app = new PIXI.Application({ width: containerWidth, height: containerHeight, backgroundColor: 0xDDDDDD}); 
    document.body.appendChild(app.view);

    // 遊戲狀態
    let state = play;

    let clock = 0 ;
    // 主角的兩張圖
    const texture0 = PIXI.Texture.from('./img/pixi/0.png'); 
    const texture1 = PIXI.Texture.from('./img/pixi/1.png');

    // 主角
    let sprite = new PIXI.Sprite(texture0);
    sprite.vx = 0;
    sprite.vy = 0;
    sprite.interactive = true; // 可以點擊
    sprite.buttonMode = true; // 滑鼠游標是手指
    sprite.on('pointerdown', onClick);
    app.stage.addChild(sprite);

    // 方向按鈕 上
    let btn_up = new PIXI.Sprite.from('./img/pixi/btn-up-60.png');
    btn_up.width = 50
    btn_up.height = 50
    btn_up.x = 10
    btn_up.y = containerHeight - 120
    btn_up.interactive = true; // 可以點擊
    btn_up.on('touchstart', btnClick_up);
    btn_up.on('touchend', btnClick_end);
    btn_up.on('touchendoutside', btnClick_end);
    app.stage.addChild(btn_up);
    // 方向按鈕 下
    let btn_dn = new PIXI.Sprite.from('./img/pixi/btn-dn-60.png');
    btn_dn.width = 50
    btn_dn.height = 50
    btn_dn.x = 10
    btn_dn.y = containerHeight - 60
    btn_dn.interactive = true; // 可以點擊
    btn_dn.on('touchstart', btnClick_dn);
    btn_dn.on('touchend', btnClick_end);
    btn_dn.on('touchendoutside', btnClick_end);
    app.stage.addChild(btn_dn);
    // 方向按鈕 左
    let btn_lf = new PIXI.Sprite.from('./img/pixi/btn-lf-60.png');
    btn_lf.width = 50
    btn_lf.height = 50
    btn_lf.x = containerWidth - 120
    btn_lf.y = containerHeight - 80
    btn_lf.interactive = true; // 可以點擊
    btn_lf.on('touchstart', btnClick_lf);
    btn_lf.on('touchend', btnClick_end);
    btn_lf.on('touchendoutside', btnClick_end);
    app.stage.addChild(btn_lf);
    // 方向按鈕 右
    let btn_rt = new PIXI.Sprite.from('./img/pixi/btn-rt-60.png');
    btn_rt.width = 50
    btn_rt.height = 50
    btn_rt.x = containerWidth - 60
    btn_rt.y = containerHeight - 80
    btn_rt.interactive = true; // 可以點擊
    btn_rt.on('touchstart', btnClick_rt);
    btn_rt.on('touchend', btnClick_end);
    btn_rt.on('touchendoutside', btnClick_end);
    app.stage.addChild(btn_rt);

    // 設定按鍵反映
    settingKey();
    
    // 循環1
    app.ticker.add(delta => gameLoop(delta));
    // 循環2
    function gameLoop(delta){
      state(delta);
    }
    // 循環3
    function play(delta) {
      clock += 1;
      if(clock >= 60) {
        clock = 0;
      }
      sprite.x += sprite.vx;
      sprite.y += sprite.vy;

      if (clock == 30) {
        sprite.texture = texture1;
      } else if (clock == 59) {
        sprite.texture = texture0;
      }
    }
    
    
    // 方向按鈕 上
    function btnClick_up() {
      sprite.vy = -3;
      sprite.vx = 0;
    }
    // 方向按鈕 下
    function btnClick_dn() {
      sprite.vy = 3;
      sprite.vx = 0;
    }
    // 方向按鈕 左
    function btnClick_lf() {
      sprite.vy = 0;
      sprite.vx = -3;
    }
    // 方向按鈕 右
    function btnClick_rt() {
      sprite.vy = 0;
      sprite.vx = 3;
    }
    
    // 方向按鈕 放開
    function btnClick_end() {
      sprite.vy = 0;
      sprite.vx = 0;
    }

    // 點主角 主角就變大
    function onClick() {
      sprite.scale.x *= 1.25;
      sprite.scale.y *= 1.25;
    }


    // 設定按鍵反映
    function settingKey() {
      // 方向鍵
      let left = keyboard(37),
        up = keyboard(38),
        right = keyboard(39),
        down = keyboard(40);

      left.press = () => {
        sprite.vx = -3;
        sprite.vy = 0;
      };
      left.release = () => {
        if (!right.isDown && sprite.vy === 0) {
          sprite.vx = 0;
        }
      };

      up.press = () => {
        sprite.vy = -3;
        sprite.vx = 0;
      };
      up.release = () => {
        if (!down.isDown && sprite.vx === 0) {
          sprite.vy = 0;
        }
      };

      right.press = () => {
        sprite.vx = 3;
        sprite.vy = 0;
      };
      right.release = () => {
        if (!left.isDown && sprite.vy === 0) {
          sprite.vx = 0;
        }
      };

      down.press = () => {
        sprite.vy = 3;
        sprite.vx = 0;
      };
      down.release = () => {
        if (!up.isDown && sprite.vx === 0) {
          sprite.vy = 0;
        }
      };
    }

    // 鍵盤按鍵
    function keyboard(keyCode) {
      let key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;
      //The `downHandler`
      key.downHandler = event => {
        if (event.keyCode === key.code) {
          if (key.isUp && key.press) key.press();
          key.isDown = true;
          key.isUp = false;
        }
        event.preventDefault();
      };
    
      //The `upHandler`
      key.upHandler = event => {
        if (event.keyCode === key.code) {
          if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
        }
        event.preventDefault();
      };
    
      //Attach event listeners
      window.addEventListener(
        "keydown", key.downHandler.bind(key), false
      );
      window.addEventListener(
        "keyup", key.upHandler.bind(key), false
      );
      return key;
    }
  </script>
</body>
</html>