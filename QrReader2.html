<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"  >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title>前端開發demo</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
</head>

<body>
  <!-- https://github.com/mebjas/html5-qrcode -->
  <div id="reader" max-width="400px" style="max-width:400px"></div>
  <div class="text-center">
    <p>建議使用 chrome 或 Safari 瀏覽器</p>
    <button class="btn btn-outline-info" onclick="window.history.go(-1);">返回</button>
    <h1>
      v18
    </h1>
    <div class="p-3">
      <input id="qrtext" type="text" class="form-control">
    </div>
  </div>

</body>

<script src="./JS/html5-qrcode.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.slim.js" integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>

<script>
  // 取得權限
  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      // 支援條碼類型
      const formatsToSupport = [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.AZTEC,
        Html5QrcodeSupportedFormats.CODABAR,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.CODE_93,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.DATA_MATRIX,
        Html5QrcodeSupportedFormats.MAXICODE,
        Html5QrcodeSupportedFormats.ITF,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.PDF_417,
        Html5QrcodeSupportedFormats.RSS_14,
        Html5QrcodeSupportedFormats.RSS_EXPANDED,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
      ];
      const html5QrCode = new Html5Qrcode( "reader", { formatsToSupport: formatsToSupport });
      const qrCodeSuccessCallback = (decodedText, decodedResult) => { 
        $("#qrtext").val(decodedText);
        // if (decodedText.includes("https://family.goodluckactivity.tw/SmartShoppingCard202108")) {
        //   $("#qrtext").val(decodedText);
        // } else {
        //   alert("非本活動QR條碼");
        // }
      };
      const config = { fps: 10, qrbox: 150 };
      html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback); //後鏡頭
    }
  }).catch(err => {
    if(err.includes('NotAllowedError')) {
      alert("需開啟瀏覽器相機權限");
    } else if(err.includes('NotFoundError')) {
      alert('無法偵測到相機');
    } else {
      alert("錯誤："+err);
    }
    window.history.go(-1); 
  });
</script>

<style>
  p{
    margin: 0;
  }
</style>

</html>